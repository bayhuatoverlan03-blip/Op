<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audiobook Library ‚Äî –º–∏–Ω–∏-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#7dd3fc; --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      font-family: Inter, Roboto, "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
    }
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#071021 0%, #071525 100%); color:#e6eef6}
    .wrap{max-width:1100px; margin:28px auto; padding:20px;}
    header{display:flex; gap:16px; align-items:center; margin-bottom:18px}
    h1{margin:0; font-size:20px; letter-spacing:0.4px}
    .grid{display:grid; gap:14px; grid-template-columns: 320px 1fr;}
    .card{background:var(--card); padding:14px; border-radius:var(--radius); box-shadow: 0 8px 24px rgba(2,6,23,0.6);}
    .small{font-size:13px; color:var(--muted)}
    label{display:block; font-size:13px; margin-top:8px}
    input[type="text"], input[type="email"], input[type="number"], select, textarea{
      width:100%; padding:8px 10px; margin-top:6px; background:var(--glass); border:1px solid rgba(255,255,255,0.03);
      color:inherit; border-radius:8px; box-sizing:border-box;
    }
    button{background:linear-gradient(90deg,var(--accent),#60a5fa); color:#022025; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted)}
    .list{display:flex; flex-direction:column; gap:8px; margin-top:10px; max-height:420px; overflow:auto; padding-right:6px}
    .item{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:10px; border-radius:10px; display:flex; justify-content:space-between; gap:10px; align-items:center}
    .meta{font-size:13px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center}
    .rating-stars{display:inline-block}
    .search{display:flex; gap:8px; align-items:center}
    footer{margin-top:16px; font-size:12px; color:var(--muted)}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìö Audiobook Library ‚Äî demo</h1>
      <div class="small">–ê–≤—Ç–æ—Ä—ã, –∫–Ω–∏–≥–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø–æ–¥–ø–∏—Å–∫–∞ –∏ —Ä–µ–π—Ç–∏–Ω–≥ ‚Äî –≤—Å—ë –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</div>
    </header>

    <div class="grid">
      <!-- LEFT: Forms -->
      <div style="display:flex; flex-direction:column; gap:12px;">
        <div class="card">
          <strong>–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞</strong>
          <label>–ò–º—è
            <input id="authorName" type="text" placeholder="–§–µ–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π">
          </label>
          <label>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è
            <textarea id="authorBio" rows="3" placeholder="–ö—Ä–∞—Ç–∫–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è"></textarea>
          </label>
          <div style="margin-top:10px">
            <button id="btnAddAuthor">–î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ—Ä–∞</button>
          </div>
        </div>

        <div class="card">
          <strong>–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É (–∞—É–¥–∏–æ–∫–Ω–∏–≥–∞)</strong>
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ
            <input id="bookTitle" type="text" placeholder="–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ (–∞—É–¥–∏–æ)">
          </label>
          <label>–ê–≤—Ç–æ—Ä
            <select id="bookAuthor"></select>
          </label>
          <label>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)
            <input id="bookDuration" type="number" min="0" value="60">
          </label>
          <label>–û–ø–∏—Å–∞–Ω–∏–µ
            <textarea id="bookDesc" rows="3"></textarea>
          </label>
          <div style="margin-top:10px">
            <button id="btnAddBook">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</button>
          </div>
        </div>

        <div class="card">
          <strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –ü–æ–¥–ø–∏—Å–∫–∞</strong>
          <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            <input id="userName" type="text" placeholder="alice">
          </label>
          <label>Email
            <input id="userEmail" type="email" placeholder="alice@example.com">
          </label>
          <div style="display:flex; gap:8px; margin-top:8px">
            <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="btnLogin" class="btn-ghost">–í–æ–π—Ç–∏</button>
          </div>

          <div style="margin-top:12px; border-top:1px solid rgba(255,255,255,0.03); padding-top:10px;">
            <div class="small">–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</div>
            <div id="currentUser" style="margin-top:6px">‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî</div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button id="btnSubscribe">–ü–æ–¥–ø–∏—Å–∫–∞ premium +30 –¥–Ω</button>
              <button id="btnUnsub" class="btn-ghost">–°–¥–µ–ª–∞—Ç—å free</button>
            </div>
          </div>
        </div>

        <div class="card">
          <strong>–ü–æ–∏—Å–∫ –∫–Ω–∏–≥ / —Å–ø–∏—Å–æ–∫</strong>
          <div class="search" style="margin-top:8px;">
            <input id="searchQuery" type="text" placeholder="–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞–≤—Ç–æ—Ä—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é">
            <button id="btnSearch" class="btn-ghost">–ü–æ–∏—Å–∫</button>
            <button id="btnClear" class="btn-ghost">–°–±—Ä–æ—Å–∏—Ç—å</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Lists -->
      <div>
        <div class="card">
          <strong>–ö–Ω–∏–≥–∏</strong>
          <div id="booksList" class="list"></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong>–ê–≤—Ç–æ—Ä—ã</strong>
          <div id="authorsList" class="list"></div>
        </div>

        <div class="card" style="margin-top:12px;">
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</strong>
          <div id="usersList" class="list"></div>
        </div>

        <footer>
          –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ localStorage. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Application ‚Üí Local Storage ‚Üí —É–¥–∞–ª–∏—Ç–µ –∫–ª—é—á <code>audiolib_data</code>.
        </footer>
      </div>
    </div>
  </div>

  <script>
  // –ü—Ä–æ—Å—Ç–∞—è –º–æ–¥–µ–ª—å –≤ localStorage, –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω–æ–π —á–∞—Å—Ç–∏.
  const STORAGE_KEY = 'audiolib_data_v1';

  // --- utilities ---
  const uid = () => 'id-' + Math.random().toString(36).slice(2,10);
  const nowISO = () => new Date().toISOString();
  const addDaysISO = (iso, days) => {
    const d = new Date(iso);
    d.setDate(d.getDate() + days);
    return d.toISOString();
  };
  function loadData(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      // seed demo data
      const a1 = {id: uid(), name: '–õ–µ–≤ –¢–æ–ª—Å—Ç–æ–π', bio: '–†—É—Å—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å.'};
      const a2 = {id: uid(), name: '–§—ë–¥–æ—Ä –î–æ—Å—Ç–æ–µ–≤—Å–∫–∏–π', bio: '–†—É—Å—Å–∫–∏–π —Ä–æ–º–∞–Ω–∏—Å—Ç.'};
      const b1 = {id: uid(), title: '–í–æ–π–Ω–∞ –∏ –º–∏—Ä (–∞—É–¥–∏–æ)', authorId: a1.id, durationMin: 360, desc:'–ö–ª–∞—Å—Å–∏–∫–∞', ratings:[], createdAt: nowISO()};
      const b2 = {id: uid(), title: '–ü—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏ –Ω–∞–∫–∞–∑–∞–Ω–∏–µ (–∞—É–¥–∏–æ)', authorId: a2.id, durationMin: 420, desc:'–†–æ–º–∞–Ω', ratings:[], createdAt: nowISO()};
      const u1 = {id: uid(), username:'alice', email:'alice@example.com', subscription: {plan:'free', start: nowISO(), expires:null}, createdAt: nowISO()};
      const state = {authors:[a1,a2], books:[b1,b2], users:[u1], meta:{}};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      return state;
    }
    try { return JSON.parse(raw); } catch(e){ console.warn('parse err',e); return null; }
  }
  function saveData(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // --- app state ---
  let state = loadData();
  let currentUserId = null;

  // --- DOM refs ---
  const $ = id => document.getElementById(id);
  const authorsSelect = $('bookAuthor');
  const authorsList = $('authorsList');
  const booksList = $('booksList');
  const usersList = $('usersList');
  const currentUserDiv = $('currentUser');

  // --- rendering ---
  function renderAuthors(){
    authorsSelect.innerHTML = '';
    authorsList.innerHTML = '';
    state.authors.forEach(a => {
      const opt = document.createElement('option'); opt.value = a.id; opt.textContent = a.name;
      authorsSelect.appendChild(opt);

      const it = document.createElement('div'); it.className = 'item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:600">${escapeHtml(a.name)}</div><div class="meta">${escapeHtml(a.bio || '')}</div>`;
      const right = document.createElement('div');
      const btnDel = document.createElement('button'); btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å'; btnDel.className='btn-ghost';
      btnDel.onclick = ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ—Ä–∞? –£–¥–∞–ª—è—Ç—Å—è –∏ –µ–≥–æ –∫–Ω–∏–≥–∏.')){ deleteAuthor(a.id); } };
      right.appendChild(btnDel);
      it.appendChild(left); it.appendChild(right);
      authorsList.appendChild(it);
    });
  }

  function renderBooks(filter){
    booksList.innerHTML = '';
    const books = state.books.filter(b => {
      if(!filter) return true;
      const q = filter.toLowerCase();
      const author = state.authors.find(a=>a.id===b.authorId);
      return (b.title||'').toLowerCase().includes(q) || (b.desc||'').toLowerCase().includes(q) || (author && author.name.toLowerCase().includes(q));
    });
    books.forEach(b => {
      const author = state.authors.find(a=>a.id===b.authorId);
      const avg = b.ratings && b.ratings.length ? (b.ratings.reduce((s,n)=>s+n,0)/b.ratings.length).toFixed(2) : '‚Äî';
      const it = document.createElement('div'); it.className='item';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(b.title)}</div>
                        <div class="meta">${escapeHtml(author ? author.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π')} ‚Ä¢ ${Math.round(b.durationMin)} –º–∏–Ω ‚Ä¢ avg: ${avg}</div>
                        <div class="meta" style="margin-top:6px">${escapeHtml(b.desc || '')}</div>`;
      const right = document.createElement('div');
      const rateWrap = document.createElement('div');
      rateWrap.style.display='flex'; rateWrap.style.flexDirection='column'; rateWrap.style.alignItems='flex-end';
      // rating input
      const stars = document.createElement('select');
      [1,2,3,4,5].forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n+'‚òÖ'; stars.appendChild(o); });
      const btnRate = document.createElement('button'); btnRate.textContent='–ü–æ—Å—Ç–∞–≤–∏—Ç—å'; btnRate.style.marginTop='6px';
      btnRate.onclick = ()=> {
        const v = Number(stars.value);
        if(!currentUserId){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.'); return; }
        rateBook(b.id, v);
      };
      const btnPlay = document.createElement('button'); btnPlay.textContent='‚ñ∂ –ü—Ä–æ—Å–ª—É—à–∞—Ç—å'; btnPlay.style.marginLeft='8px';
      btnPlay.className='btn-ghost';
      btnPlay.onclick = ()=> {
        const u = state.users.find(uu=>uu.id===currentUserId);
        if(!u){ alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–ª—É—à–∞—Ç—å.'); return; }
        if(u.subscription.plan !== 'premium' && u.subscription.plan !== 'free'){
          alert('–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω.');
          return;
        }
        // demo: restrict listening if not premium and duration > 300 (example)
        if(u.subscription.plan !== 'premium' && b.durationMin > 300){
          alert('–≠—Ç–∞ –∞—É–¥–∏–æ–∫–Ω–∏–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è premium-–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤. –ù–∞–∂–º–∏—Ç–µ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –ø—Ä–æ–±–æ–≤–∞—Ç—å.');
          return;
        }
        alert('–î–µ–º–æ: –∑–∞–ø—É—Å–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è (–∏–º–∏—Ç–∞—Ü–∏—è).');
      };

      const btnDel = document.createElement('button'); btnDel.textContent='–£–¥–∞–ª–∏—Ç—å'; btnDel.className='btn-ghost';
      btnDel.onclick = ()=> { if(confirm('–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É?')){ deleteBook(b.id); } };

      const meta = document.createElement('div'); meta.className='meta'; meta.style.marginTop='8px';
      meta.textContent = '–û—Ü–µ–Ω–∫–∏: ' + (b.ratings.length ? b.ratings.join(', ') : '‚Äî');

      rateWrap.appendChild(stars);
      rateWrap.appendChild(btnRate);
      rateWrap.appendChild(btnPlay);
      rateWrap.appendChild(btnDel);

      it.appendChild(left);
      const rightCol = document.createElement('div');
      rightCol.appendChild(rateWrap);
      it.appendChild(rightCol);
      it.appendChild(meta);
      booksList.appendChild(it);
    });
  }

  function renderUsers(){
    usersList.innerHTML='';
    state.users.forEach(u=>{
      const it = document.createElement('div'); it.className='item';
      const left = document.createElement('div');
      const subActive = u.subscription && (u.subscription.plan==='free' || (u.subscription.expires && new Date() <= new Date(u.subscription.expires)));
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(u.username)}</div>
                        <div class="meta">${escapeHtml(u.email||'‚Äî')} ‚Ä¢ ${escapeHtml(u.subscription.plan || 'free')} ${u.subscription.expires ? '–¥–æ '+(new Date(u.subscription.expires)).toLocaleString() : ''}</div>`;
      const right = document.createElement('div');
      const btnSet = document.createElement('button'); btnSet.textContent='–í—ã–±—Ä–∞—Ç—å'; btnSet.onclick = ()=> { currentUserId = u.id; renderCurrentUser(); };
      const btnSub = document.createElement('button'); btnSub.textContent='+30d premium'; btnSub.className='btn-ghost';
      btnSub.onclick = ()=>{ subscribeUser(u.id, 30); };
      right.appendChild(btnSet); right.appendChild(btnSub);
      it.appendChild(left); it.appendChild(right);
      usersList.appendChild(it);
    });
  }

  function renderCurrentUser(){
    if(!currentUserId){ currentUserDiv.textContent='‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî'; return; }
    const u = state.users.find(x=>x.id===currentUserId);
    if(!u){ currentUserDiv.textContent='(–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω)'; return; }
    const exp = u.subscription.expires ? new Date(u.subscription.expires).toLocaleString() : '‚Äî';
    currentUserDiv.innerHTML = `<strong>${escapeHtml(u.username)}</strong> ‚Ä¢ ${escapeHtml(u.email||'‚Äî')}<div class="meta">plan: ${u.subscription.plan} ‚Ä¢ expires: ${exp}</div>`;
  }

  // --- actions ---
  function addAuthor(){
    const name = $('authorName').value.trim();
    const bio = $('authorBio').value.trim();
    if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∞–≤—Ç–æ—Ä–∞'); return; }
    const a = {id: uid(), name, bio};
    state.authors.push(a); saveData(state); renderAuthors(); renderBooks(); renderUsers();
    $('authorName').value=''; $('authorBio').value='';
  }

  function addBook(){
